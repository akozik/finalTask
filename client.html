<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Task Manager</title>
</head>
<body>

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


<script src="https://code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" crossorigin="anonymous"></script>
<script src="js/jquery.slidereveal.min.js"></script>
<style>
    html, body{
        height:100%;
        width:100%;
    }
    .fon{
        position: absolute;
        left:30%;
        height:100vh;
    }
    .main{
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        height:100%;
    }
    .left-container{
        min-width: 30%;
        height:100%;
    }
    .left-container-items{
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        padding: 10px;
    }
    .panel{
        margin: 0;
    }
    .side-panel-right {
        box-shadow: 5px 0 15px -6px #585858 inset;
    }
    .side-panel {
        background-color: #ffffff;
        padding: 10px;
    }
    .text-label{
        font-size: 14px;
        color: #aeaeae;
        font-weight: 100;
    }
    .new-preview-task{
        background-color: #f9f9f9;
        padding: 10px;
    }
    .new-form-task{
        background-color: #ffffff;
        padding: 10px;
    }
    .preview-text{
        font-size: 20px;
    }
    .preview-location{
        font-size: 13px;
    }
    .static-location{
        font-size: 20px;
        font-weight: bold;
    }
    .link_new_task{
        font-size: 20px;
        text-decoration: none;
    }
    .link_new_task:hover{
        text-decoration: none;
    }

    /* =============================================
    * RADIO BUTTONS
    =============================================== */
    .radios{
        display: flex;
        flex-direction: row;
        justify-content: center;
        flex-wrap: wrap;
    }
    .radios label {
        cursor: pointer;
        position: relative;
        margin-left: 15px;
        text-align: center;
    }

    input[type="radio"] {
        opacity: 0; /* hidden but still tabable */
        position: absolute;
        margin: 2px;
    }

    input[type="radio"] + .icons {
        border-radius: 20%;
        padding: 2px;
    }

    input[type="radio"]:checked + .icons {
        background-color: #728FFF;
    }

    input[type="radio"] + .texts {
        border-radius: 30%;
        padding: 10px;
    }

    input[type="radio"]:checked + .texts {
        border: 1px solid #728FFF;
    }

    .icons{
        height:60px;
        width:60px;
    }
    .icon-text{
        margin: 5px;
        text-align: center;
        font-size: 13px;
    }



</style>
<img class="fon" src="img/map_bg.png"/>

<div class="main">
    <div class="left-container"></div>
</div>


<div id="create_task_panel" class="side-panel side-panel-right">

    <div class="new-preview-task">
        <label class="text-label"><h5>NEW TASK</h5></label>

        <p id="preview-text" class="preview-text"></p>
        <div class="form-group">
            <button type="button" class="btn btn-primary" onclick="RestPOST()" id="save_oper">Create Task</button>
        </div>
    </div>

    <div class="new-form-task">
        <label class="text-label"><h5>LOCATION</h5></label>
        <p class="static-location" id="task-location">141 Ogunlana Dr, Lagos 10128</p>
        <hr>
        <label class="text-label"><h5>SERVICE TYPE</h5></label>
        <div class="radios" id="category"></div>
        <hr>
        <label class="text-label"><h5>PLUMBER TASKS</h5></label>
        <div class="radios" id="subcategory"></div>
        <hr>
        <div class="form-group">
            <label class="text-label">TASK DESCRIPTION</label>
            <div>
                <textarea class="form-control" rows="3" id="task-description"></textarea>
            </div>
        </div>
    </div>

</div>

<script>
    var left_container = $('.left-container');

    var slider =$('#create_task_panel').slideReveal({
        push: false,
        overlay: true,
        position:"right",
        width:"30%"
    });

    var Model = {};
    var TaskList = {};
    var Id = '';


    // https://nnattawat.github.io/slideReveal/
    $(function(){
        RestGet();
    });

    function RestGet(){
        left_container.html('').append('<div class="left-container-items">'+
            '<div class="panel panel-default">'+
            '<div class="panel-body" align="center">'+
            '<a href="#" id="create_task_button" class="link_new_task" onclick="CreateTrigger()">+ NEW TASK</a>'+
            '</div>'+
            '</div>'+
            '</div>');

        $.ajax({
            url: 'http://localhost:3333/tasklist',
            type: 'GET',
            dataType: "json",
        })

        .done(function( data ) {

            TaskList = data;
            data.forEach(function(currentValue, index, array){
                left_container.append('<div class="left-container-items">\n' +
                    '<div class="panel panel-default">\n' +
                    '<div class="panel-body">\n' +
                    '<p>'+currentValue['TaskText'] +'</p>'+
                    '<p><button type="button" class="btn btn-primary btn-sm" onclick="EditTrigger(\''+currentValue['id'] +'\', \''+index+'\')">EDIT</button>'+
                    '&nbsp;<a href="#" onclick="RestDELETE(\''+currentValue['id'] +'\')">DELETE</a></p>'+
                    '</div>\n' +
                    '</div>\n' +
                    '</div>');
            });
        });
    }

    function RestPOST()
    {
        $.ajax({
            method: "POST",
            url: "http://localhost:3333/taskstore",
            cache: false,
            data: Model
        })
        .done(function( html ) {
            RestGet();
        });
    }

    function RestDELETE( id ){
        $.ajax({
            method: "DELETE",
            url: "http://localhost:3333/taskdelete",
            cache: false,
            data: {id : id}
        })
        .done(function( html ) {
            RestGet();
        });
    }

    function CreateTrigger(){
        Id = '';
        $('#save_oper').text('Create Task');
        slider.slideReveal('toggle');
        renderCategory(0);
        renderSubCategory(0, 0);
        $('#task-description').val('');
        AssemblyTaskText();
    }

    function EditTrigger( id , ind ) {
        Id = id;
        $('#save_oper').text('Edit Task');
        slider.slideReveal('toggle');
        renderCategory(TaskList[ind]['Category']);
        renderSubCategory(TaskList[ind]['Category'], TaskList[ind]['SubCategory']);
        $('#task-description').val(TaskList[ind]['Description']);
        AssemblyTaskText();
    }


    var options = {
        "Electrician":[
            "Eemergency electrician",
            "Lighting",
            "Switchboard upgrade",
            "Alarm systems",
            "Electrical testing",
            "Longreach service agents"
        ],
        "Plumber":[
            "Unblock a toilet",
            "Unblock a sink",
            "Fix a water leak",
            "Install a sink",
            "Install a shower",
            "Install a toilet"
        ],
        "Gardener":[
            "Landscaper",
            "Cemetery worker",
            "Fence installer",
            "Florist",
            "Groundsperson"
        ],
        "Housekeeper":[
            "Dishwashing",
            "Trash disposal",
            "Windexing",
            "Baseboards",
            "Bed makings",
            "Dusting"
        ],
        "Cook":[
            "Food Safety",
            "Kitchen Management",
            "Gastronomy",
            "Nutrition",
            "Culinary Math",
            "Product Knowledge"
        ]
    };

    var category = $('#category');
    var subcategory = $('#subcategory');

    function renderCategory(id)
    {

         var categoryList = Object.getOwnPropertyNames(options);
         var categoryHtml = '';
         categoryList.forEach(function(item) {
                categoryHtml+='<label>' +
                    '<input type="radio" name="service_type" value="'+item+'" id="'+categoryList.indexOf(item)+'" '+(categoryList.indexOf(item) === id?'checked':'')+'/>'+
                        '<img src="img/'+item+'.png" class="icons" onclick="renderSubCategory('+categoryList.indexOf(item)+', 0)">'+
                        '<p class="icon-text">'+item+'</p>'+
                    '</label>';
         });
        category.html(categoryHtml);
    }

    function renderSubCategory(id1, id2)
    {
        var id1_name = '';
        var categoryList = Object.getOwnPropertyNames(options);
        categoryList.forEach(function(item) {
            //console.log(categoryList.indexOf(item), id1, item);
            if(categoryList.indexOf(item) === id1){
                id1_name = item;
            }
        });

        var subcategoryHtml = '';
        if(options[id1_name] !== undefined){
            $.each(options[id1_name], function(index, value) {
                subcategoryHtml+='<label>' +
                    '<input type="radio" name="sub_service" id="'+index+'" value="'+value+'" '+(index === id2?'checked':'')+'/>'+
                    '<p class="icon-text texts">'+value+'</p>'+
                    '</label>';
            });
        }
        subcategory.html(subcategoryHtml);
        refreshListiner();
    }

    function AssemblyTaskText( id )
    {
        let Category = '';
        let CategoryID = 0;
        let SubCategory = '';
        let SubCategoryID = 0;
        let Description = '';

        let TaskText = '';
        let TaskAddress = '';

        $('input[type=radio]:checked').each(function (index) {
            if($(this).attr('name') === 'service_type'){
                Category = $(this).attr('value');
                CategoryID = $(this).attr('id');
            }
            else if($(this).attr('name') === 'sub_service'){
                SubCategory = $(this).attr('value');
                SubCategoryID = $(this).attr('id');
            }
        });

        Description = $('#task-description').val();
        TaskAddress = $('#task-location').text();

        TaskText =
            (Category!==''?'I need ':'') + '<b>'+ Category + '</b>'+
            (SubCategory!==''?' to ':'') + '<b>' + SubCategory + '</b>'+
            (Description!==''?', ':'') + '<b>' + Description + '</b><br>'+
            '<p class="preview-location">My address is '+ TaskAddress + '</p>';

        $('#preview-text').html(TaskText);

        fillModel(
            {
                id: Id,
                TaskText: TaskText,
                TaskAddress: TaskAddress,
                Category: CategoryID,
                SubCategory: SubCategoryID,
                Description: Description
            }
        );

    }

    function fillModel( Obj ){
        Model = Obj;
        return Model;
    }

    function refreshListiner(){
        $('input[type=radio], textarea[id=task-description]')
            .on('click', function () {
            AssemblyTaskText();
        })
            .on('blur', function () {
            AssemblyTaskText();
        })
            .on('keyup', function () {
            AssemblyTaskText();
        })
    }

</script>
</body>
</html>